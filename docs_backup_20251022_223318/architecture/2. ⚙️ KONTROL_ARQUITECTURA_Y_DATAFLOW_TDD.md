# ⚙️ KONTROL: Arquitectura de Sistemas y Dataflow (Technical Design Document)

## 1. Justificación del Stack Híbrido: Rendimiento y Moat 🧱

La complejidad de la fiscalidad cripto exige una arquitectura de datos que balancee la fiabilidad transaccional, la analítica masiva y el análisis relacional forense.

| Base de Datos | Tipo | Rol Crítico | Justificación Técnica de la Decisión |
| :--- | :--- | :--- | :--- |
| **PostgreSQL** | Transaccional (ACID) | **Core Banking & Metadata.** Almacena perfiles de usuario, estado de *jobs* (ingesta), reportes finales (PDF/JSON) y VCs. | Fiabilidad crítica para datos de cumplimiento. |
| **ClickHouse** | Columnar (OLAP) | **Tax Engine & Analítica Masiva.** Almacena el esquema canónico de TXs. Permite *queries* agregadas complejas (P&L por FIFO/HIFO) en milisegundos. | Imposible de lograr con PostgreSQL en escenarios de millones de TXs. |
| **Neo4j** | Grafo | **Forensic Analytics & Security Agent.** Modela las relaciones *Wallet-TX-Exchange-Cluster*. Base del *Risk Scoring* y **Proof-of-Origin**. | Es el **Moat**; permite algoritmos de detección de fraude (Community Detection, PageRank). |

## 2. Arquitectura de Microservicios Desacoplados (DDD)

El sistema se divide en dominios claros para optimizar el rendimiento y permitir la escalabilidad independiente.

| Servicio | Tecnología Core | Función Detallada | Interfaz Principal |
| :--- | :--- | :--- | :--- |
| **Matching Engine** | **Rust** | Motor de reconciliación de TXs, cálculo exacto de *Cost Basis* (punto de máximo rendimiento). | API REST (llamado por el Ingestion Service). |
| **Ingestion Service** | **Go (Golang)** | Conexión con *sources* (APIs de Exchange, RPCs), *rate limiting*, inicializa el ETL. | API REST (interna/externa), Webhooks. |
| **API Gateway** | **Go** | *Routing* para Frontend (GraphQL) y B2B (REST). Manejo de autenticación (JWT). | GraphQL, REST (OpenAPI). |
| **Agent Orchestrator** | **Python (FastAPI)** | Orquestación de los 4 agentes IA (LangChain/LangGraph) y gestión del *Tool Use*. | API REST (interna). |

## 3. Dataflow de Ingesta (ETL Pipeline Crítico) 🌊

El *pipeline* de ETL garantiza la **Cost Basis Accuracy (CBA)**:

1.  **Extract (E) - Ingestion Service (Go):** Recolección de datos crudos (Raw Data) desde APIs, RPCs y *parsers* de CSV. Envío asíncrono a Kafka/PubSub.
2.  **Transform (T) - Matching Engine (Rust):** Desduplicación, Normalización a Esquema Canónico KONTROL. Ejecución del algoritmo forense para clasificar **INTERNAL\_TRANSFER** y corregir *missing TXs*.
3.  **Load (L) - Loading Service (Go):** Distribución concurrente de la TX canónica a **ClickHouse** (analítica fiscal) y **Neo4j** (grafo forense) para indexing.
4.  **Enrich (E') - Agent Orchestrator (Python):** Generación de **Embeddings Vectoriales** de la TX y su almacenamiento en **Vector Store (Chroma/Redis)** para la consulta RAG de los agentes.