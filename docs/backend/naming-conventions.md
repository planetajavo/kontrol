# üìù Naming Conventions - Backend

> Est√°ndares de nomenclatura para el backend de KONTROL

## üéØ Filosof√≠a

**Principio**: El c√≥digo debe ser **auto-documentado** y f√°cil de entender.

- ‚úÖ Nombres descriptivos > Nombres cortos
- ‚úÖ Consistencia > Conveniencia personal
- ‚úÖ Python standards (PEP 8) siempre

---

## üìÅ Archivos y Carpetas

### Archivos Python
```python
‚úÖ CORRECTO:
- address_service.py
- matching_engine.py
- transaction_agent.py
- api_gateway.py

‚ùå INCORRECTO:
- AddressService.py
- matchingEngine.py
- TransactionAgent.py
- API_Gateway.py
```

**Regla**: `snake_case` para todos los archivos Python

### Carpetas
```
‚úÖ CORRECTO:
- core/
- matching_engine/
- api/
- integrations/

‚ùå INCORRECTO:
- Core/
- matchingEngine/
- API/
- Integrations/
```

**Regla**: `lowercase` con `snake_case` si es necesario

---

## üî§ Variables y Funciones

### Variables
```python
‚úÖ CORRECTO:
user_id = "123"
address_list = []
transaction_count = 0
is_valid = True

‚ùå INCORRECTO:
userId = "123"
AddressList = []
TransactionCount = 0
IsValid = True
```

**Regla**: `snake_case` para variables

### Constantes
```python
‚úÖ CORRECTO:
MAX_ADDRESSES = 100
API_VERSION = "1.0"
DEFAULT_TIMEOUT = 30

‚ùå INCORRECTO:
maxAddresses = 100
api_version = "1.0"
defaultTimeout = 30
```

**Regla**: `UPPER_SNAKE_CASE` para constantes

### Funciones
```python
‚úÖ CORRECTO:
def get_user_addresses(user_id: str):
    pass

def calculate_cost_basis(transactions: list):
    pass

async def fetch_blockchain_data(address: str):
    pass

‚ùå INCORRECTO:
def GetUserAddresses(userId: str):
    pass

def CalculateCostBasis(transactions: list):
    pass
```

**Regla**: `snake_case` para funciones

---

## üèóÔ∏è Clases y Modelos

### Clases
```python
‚úÖ CORRECTO:
class AddressService:
    pass

class MatchingEngine:
    pass

class TransactionAgent:
    pass

‚ùå INCORRECTO:
class address_service:
    pass

class matchingEngine:
    pass

class transaction_agent:
    pass
```

**Regla**: `PascalCase` para clases

### Modelos SQLAlchemy
```python
‚úÖ CORRECTO:
class User(Base):
    __tablename__ = "users"
    
class Address(Base):
    __tablename__ = "addresses"
    
class Transaction(Base):
    __tablename__ = "transactions"

‚ùå INCORRECTO:
class user(Base):
    __tablename__ = "Users"
```

**Regla**: 
- Clase en `PascalCase` (singular)
- Tabla en `snake_case` (plural)

### Modelos Pydantic
```python
‚úÖ CORRECTO:
class AddressImportRequest(BaseModel):
    addresses: List[str]

class TransactionResponse(BaseModel):
    id: str
    amount: Decimal

‚ùå INCORRECTO:
class address_import_request(BaseModel):
    Addresses: List[str]
```

**Regla**: `PascalCase` + sufijos descriptivos (Request, Response, Schema)

---

## üåê API Endpoints

### REST Endpoints
```python
‚úÖ CORRECTO:
@router.post("/api/addresses/import")
@router.get("/api/addresses")
@router.get("/api/addresses/{address_id}")
@router.put("/api/transactions/{tx_id}")

‚ùå INCORRECTO:
@router.post("/api/Addresses/Import")
@router.get("/api/addresses/getAll")
@router.get("/api/addresses/GetById/{id}")
```

**Reglas**:
- Siempre `lowercase`
- Plural para colecciones: `/addresses`, `/transactions`
- Singular para acciones: `/import`, `/sync`
- IDs con `snake_case`: `{address_id}`, `{user_id}`

### Verbos HTTP
```python
‚úÖ CORRECTO:
GET    /api/addresses          # Listar
POST   /api/addresses/import   # Crear/Importar
GET    /api/addresses/{id}     # Obtener uno
PUT    /api/addresses/{id}     # Actualizar
DELETE /api/addresses/{id}     # Eliminar

‚ùå INCORRECTO:
GET /api/addresses/getAll
POST /api/addresses/create
GET /api/addresses/get/{id}
```

**Regla**: Usar verbos HTTP correctamente, no en la URL

---

## üìä Base de Datos

### Tablas
```sql
‚úÖ CORRECTO:
users
addresses
transactions
portfolios
tax_reports

‚ùå INCORRECTO:
Users
address
Transaction
portfolio
TaxReports
```

**Regla**: `snake_case`, plural

### Columnas
```sql
‚úÖ CORRECTO:
id, user_id, created_at, updated_at
address, chain, label
tx_hash, amount, asset

‚ùå INCORRECTO:
Id, userId, CreatedAt
Address, Chain, Label
TxHash, Amount, Asset
```

**Regla**: `snake_case`

### Foreign Keys
```sql
‚úÖ CORRECTO:
user_id REFERENCES users(id)
address_id REFERENCES addresses(id)
portfolio_id REFERENCES portfolios(id)

‚ùå INCORRECTO:
userId REFERENCES Users(Id)
addressId REFERENCES Address(id)
```

**Regla**: `tabla_singular_id`

---

## üîß Configuraci√≥n y Entorno

### Variables de Entorno
```bash
‚úÖ CORRECTO:
SUPABASE_URL=...
SUPABASE_KEY=...
OPENAI_API_KEY=...
DATABASE_URL=...

‚ùå INCORRECTO:
supabase_url=...
SupabaseKey=...
openaiApiKey=...
```

**Regla**: `UPPER_SNAKE_CASE`

### Archivos de Config
```python
‚úÖ CORRECTO:
config/settings.py
config/database.py
config/logging.py

‚ùå INCORRECTO:
config/Settings.py
config/Database.py
config/Logging.py
```

**Regla**: `snake_case`

---

## üìù Comentarios y Docstrings

### Funciones
```python
‚úÖ CORRECTO:
def calculate_cost_basis(
    transactions: List[Transaction],
    method: str = "FIFO"
) -> Decimal:
    """
    Calcula el cost basis de transacciones usando el m√©todo especificado.
    
    Args:
        transactions: Lista de transacciones a procesar
        method: M√©todo de c√°lculo (FIFO, LIFO, HIFO)
    
    Returns:
        Cost basis total como Decimal
    
    Raises:
        ValueError: Si el m√©todo no es v√°lido
    """
    pass

‚ùå INCORRECTO:
def calculateCostBasis(txs, mthd="FIFO"):
    # calcula cost basis
    pass
```

**Regla**: Google-style docstrings en espa√±ol

### Clases
```python
‚úÖ CORRECTO:
class MatchingEngine:
    """
    Motor de reconciliaci√≥n de transacciones.
    
    Identifica transferencias internas y calcula cost basis
    usando diferentes m√©todos (FIFO, LIFO, HIFO).
    
    Attributes:
        method: M√©todo de c√°lculo por defecto
        tolerance: Tolerancia para matching (0.001 = 0.1%)
    """
    
    def __init__(self, method: str = "FIFO"):
        self.method = method
        self.tolerance = 0.001
```

---

## üß™ Tests

### Archivos de Test
```python
‚úÖ CORRECTO:
tests/test_address_service.py
tests/test_matching_engine.py
tests/test_tax_calculations.py

‚ùå INCORRECTO:
tests/AddressServiceTest.py
tests/test_matchingEngine.py
tests/TestTaxCalculations.py
```

**Regla**: `test_` prefix + `snake_case`

### Funciones de Test
```python
‚úÖ CORRECTO:
def test_import_valid_addresses():
    pass

def test_calculate_cost_basis_fifo():
    pass

async def test_fetch_blockchain_data():
    pass

‚ùå INCORRECTO:
def testImportValidAddresses():
    pass

def test_calculateCostBasisFIFO():
    pass
```

**Regla**: `test_` prefix + descripci√≥n descriptiva

---

## üì¶ Imports

### Orden de Imports
```python
‚úÖ CORRECTO:
# Standard library
import os
import sys
from datetime import datetime

# Third-party
from fastapi import FastAPI, HTTPException
from sqlalchemy import Column, String
import pandas as pd

# Local
from config.settings import get_settings
from models.address import Address
from services.address_service import AddressService

‚ùå INCORRECTO:
# Todo mezclado
from models.address import Address
import os
from fastapi import FastAPI
import pandas as pd
from config.settings import get_settings
```

**Regla**: stdlib ‚Üí third-party ‚Üí local, con l√≠neas en blanco

---

## üéØ Ejemplos Completos

### Service Example
```python
# services/address_service.py

from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from models.address import Address
from schemas.address import AddressCreate, AddressResponse

class AddressService:
    """Servicio para gesti√≥n de direcciones de wallet."""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def import_addresses(
        self,
        user_id: str,
        addresses: List[str]
    ) -> List[AddressResponse]:
        """
        Importa m√∫ltiples direcciones para un usuario.
        
        Args:
            user_id: ID del usuario
            addresses: Lista de direcciones a importar
        
        Returns:
            Lista de direcciones creadas
        """
        created_addresses = []
        
        for addr in addresses:
            if self._validate_address(addr):
                db_address = Address(
                    user_id=user_id,
                    address=addr
                )
                self.db.add(db_address)
                created_addresses.append(db_address)
        
        await self.db.commit()
        return created_addresses
    
    def _validate_address(self, address: str) -> bool:
        """Valida formato de direcci√≥n."""
        # Implementaci√≥n...
        return True
```

### API Endpoint Example
```python
# api/rest/addresses.py

from fastapi import APIRouter, Depends, HTTPException
from typing import List
from schemas.address import AddressImportRequest, AddressResponse
from services.address_service import AddressService

router = APIRouter(prefix="/api/addresses", tags=["addresses"])

@router.post("/import", response_model=AddressResponse)
async def import_addresses(
    request: AddressImportRequest,
    service: AddressService = Depends(get_address_service)
):
    """
    Importa direcciones de wallet.
    
    - **addresses**: Lista de direcciones a importar
    """
    try:
        result = await service.import_addresses(
            user_id="user_123",  # TODO: Get from auth
            addresses=request.addresses
        )
        return {
            "success": True,
            "imported": len(result),
            "addresses": result
        }
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))
```

---

## ‚úÖ Checklist de C√≥digo

Antes de hacer commit, verifica:

- [ ] Nombres en `snake_case` (archivos, variables, funciones)
- [ ] Clases en `PascalCase`
- [ ] Constantes en `UPPER_SNAKE_CASE`
- [ ] Endpoints en `lowercase`
- [ ] Docstrings en funciones p√∫blicas
- [ ] Imports ordenados correctamente
- [ ] No hay typos en nombres
- [ ] Nombres descriptivos (no abreviaturas raras)

---

## üö´ Qu√© Evitar

### Abreviaturas Confusas
```python
‚ùå NO:
def get_addr(usr_id):  # ¬øaddr? ¬øaddress?
    tmp = []           # ¬øtmp? ¬øtemporal?
    res = calc()       # ¬øres? ¬øresult? ¬øresponse?

‚úÖ S√ç:
def get_address(user_id):
    addresses = []
    result = calculate_cost_basis()
```

### Nombres Gen√©ricos
```python
‚ùå NO:
data = get_data()
info = process_info()
temp = []

‚úÖ S√ç:
transactions = get_transactions()
portfolio = process_portfolio_data()
validated_addresses = []
```

### Inconsistencia
```python
‚ùå NO:
getUserAddresses()  # camelCase
get_user_txs()      # abreviaci√≥n
GetUserPortfolio()  # PascalCase

‚úÖ S√ç:
get_user_addresses()
get_user_transactions()
get_user_portfolio()
```

---

**Recuerda**: La consistencia es m√°s importante que tu preferencia personal.

**√öltima actualizaci√≥n**: 2025-10-22
