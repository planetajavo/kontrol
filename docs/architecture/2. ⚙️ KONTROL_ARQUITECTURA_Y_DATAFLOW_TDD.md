# 锔 KONTROL: Arquitectura de Sistemas y Dataflow (Technical Design Document)

## 1. Justificaci贸n del Stack H铆brido: Rendimiento y Moat П

La complejidad de la fiscalidad cripto exige una arquitectura de datos que balancee la fiabilidad transaccional, la anal铆tica masiva y el an谩lisis relacional forense.

| Base de Datos | Tipo | Rol Cr铆tico | Justificaci贸n T茅cnica de la Decisi贸n |
| :--- | :--- | :--- | :--- |
| **PostgreSQL** | Transaccional (ACID) | **Core Banking & Metadata.** Almacena perfiles de usuario, estado de *jobs* (ingesta), reportes finales (PDF/JSON) y VCs. | Fiabilidad cr铆tica para datos de cumplimiento. |
| **ClickHouse** | Columnar (OLAP) | **Tax Engine & Anal铆tica Masiva.** Almacena el esquema can贸nico de TXs. Permite *queries* agregadas complejas (P&L por FIFO/HIFO) en milisegundos. | Imposible de lograr con PostgreSQL en escenarios de millones de TXs. |
| **Neo4j** | Grafo | **Forensic Analytics & Security Agent.** Modela las relaciones *Wallet-TX-Exchange-Cluster*. Base del *Risk Scoring* y **Proof-of-Origin**. | Es el **Moat**; permite algoritmos de detecci贸n de fraude (Community Detection, PageRank). |

## 2. Arquitectura de Microservicios Desacoplados (DDD)

El sistema se divide en dominios claros para optimizar el rendimiento y permitir la escalabilidad independiente.

| Servicio | Tecnolog铆a Core | Funci贸n Detallada | Interfaz Principal |
| :--- | :--- | :--- | :--- |
| **Matching Engine** | **Rust** | Motor de reconciliaci贸n de TXs, c谩lculo exacto de *Cost Basis* (punto de m谩ximo rendimiento). | API REST (llamado por el Ingestion Service). |
| **Ingestion Service** | **Go (Golang)** | Conexi贸n con *sources* (APIs de Exchange, RPCs), *rate limiting*, inicializa el ETL. | API REST (interna/externa), Webhooks. |
| **API Gateway** | **Go** | *Routing* para Frontend (GraphQL) y B2B (REST). Manejo de autenticaci贸n (JWT). | GraphQL, REST (OpenAPI). |
| **Agent Orchestrator** | **Python (FastAPI)** | Orquestaci贸n de los 4 agentes IA (LangChain/LangGraph) y gesti贸n del *Tool Use*. | API REST (interna). |

## 3. Dataflow de Ingesta (ETL Pipeline Cr铆tico) 

El *pipeline* de ETL garantiza la **Cost Basis Accuracy (CBA)**:

1.  **Extract (E) - Ingestion Service (Go):** Recolecci贸n de datos crudos (Raw Data) desde APIs, RPCs y *parsers* de CSV. Env铆o as铆ncrono a Kafka/PubSub.
2.  **Transform (T) - Matching Engine (Rust):** Desduplicaci贸n, Normalizaci贸n a Esquema Can贸nico KONTROL. Ejecuci贸n del algoritmo forense para clasificar **INTERNAL\_TRANSFER** y corregir *missing TXs*.
3.  **Load (L) - Loading Service (Go):** Distribuci贸n concurrente de la TX can贸nica a **ClickHouse** (anal铆tica fiscal) y **Neo4j** (grafo forense) para indexing.
4.  **Enrich (E') - Agent Orchestrator (Python):** Generaci贸n de **Embeddings Vectoriales** de la TX y su almacenamiento en **Vector Store (Chroma/Redis)** para la consulta RAG de los agentes.